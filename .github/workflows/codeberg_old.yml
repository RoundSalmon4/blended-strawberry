name: Sync Old Releases to Codeberg

on:
  workflow_call:
  workflow_dispatch:  # Trigger manually

permissions:
  contents: write  # Allow action to write to repository
  issues: write
  pull-requests: write
  deployments: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clean Previous Downloads
        shell: bash
        run: |
          echo "Cleaning up previous downloads..."
          rm -f *.dmg *.exe

      - name: Get Releases List
        id: get_releases
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          all_releases=$(curl -s -H "Authorization: token ${GH_TOKEN}" \
            "https://api.github.com/repos/${{ github.repository }}/releases")
          echo "${all_releases}" | jq -r '.[] | select(.prerelease == false) | .tag_name' > releases.txt

      - name: Find first unuploaded release tag
        shell: bash
        env:
          CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}
        run: |
          set -euo pipefail
          found_unuploaded_release=0

          # Fetch existing Codeberg releases once (paginate naïvely—adjust if you have many)
          cb_releases=$(curl -s -H "Authorization: token ${CODEBERG_TOKEN}" \
            "https://codeberg.org/api/v1/repos/unwanted9855/blended-strawberry/releases")

          while IFS= read -r tag_name; do
            [ -z "${tag_name}" ] && continue
            if echo "${cb_releases}" | jq -e --arg t "${tag_name}" '.[] | select(.tag_name == $t)' >/dev/null 2>&1; then
              echo "Release for tag ${tag_name} already exists on Codeberg. Skipping..."
            else
              echo "Found unuploaded release tag: ${tag_name}"
              echo "tag_name=${tag_name}" >> "$GITHUB_ENV"
              found_unuploaded_release=1
              break
            fi
          done < releases.txt

          if [ $found_unuploaded_release -eq 0 ]; then
            echo "No unuploaded release found."
            # Exit 1 indicates nothing to do; switch to 0 if you prefer green runs on 'no work'
            exit 1
          fi

      - name: Download Assets
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${{ env.tag_name }}" ]; then
            echo "No tag found for downloading assets."
            exit 1
          fi

          rel=$(curl -s -H "Authorization: token ${GH_TOKEN}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ env.tag_name }}")

          if [ -z "${rel}" ] || [ "${rel}" = "null" ]; then
            echo "No release payload found for tag ${{ env.tag_name }}."
            exit 1
          fi

          echo "${rel}" | jq -r '.assets[] | "\(.name) \(.browser_download_url)"' > assets.txt || true

          if [ ! -s assets.txt ]; then
            echo "No assets listed for tag ${{ env.tag_name }}."
            exit 1
          fi

          while IFS= read -r line; do
            asset_name=$(echo "$line" | awk '{print $1}')
            asset_url=$(echo "$line" | awk '{print $2}')
            if [ -z "${asset_name}" ] || [ -z "${asset_url}" ]; then
              echo "Skipping malformed asset line: $line"
              continue
            fi
            echo "Downloading asset: ${asset_name} from: ${asset_url}"
            if curl -fSL -o "${asset_name}" "${asset_url}"; then
              echo "${asset_name} downloaded successfully."
            else
              echo "Failed to download ${asset_name}. Exiting."
              exit 1
            fi
          done < assets.txt

      - name: Verify Downloads
        shell: bash
        run: |
          echo "Downloaded Files:"
          ls -al *.exe *.dmg || echo "No .exe/.dmg files matched."

      # ───────────────────────────────────────────────────────────────
      # Option A: Guard the Codeberg side effects (create/upload release)
      # ───────────────────────────────────────────────────────────────

      - name: "[TEST] Skipping Codeberg release create/upload (NO_SIDE_EFFECTS=true)"
        if: ${{ vars.NO_SIDE_EFFECTS == 'true' }}
        run: echo "[TEST] NO_SIDE_EFFECTS=true → Codeberg release creation and asset uploads are skipped"

      - name: Upload Assets to Codeberg
        if: ${{ vars.NO_SIDE_EFFECTS != 'true' }}
        shell: bash
        env:
          CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${{ env.tag_name }}" ]; then
            echo "No tag found in env.tag_name; cannot continue."
            exit 1
          fi

          if [ -z "${CODEBERG_TOKEN:-}" ]; then
            echo "ERROR: CODEBERG_TOKEN is not set; cannot create/upload release on Codeberg."
            exit 1
          fi

          echo "Checking for release with tag ${{ env.tag_name }}."
          release_check=$(curl -s -H "Authorization: token ${CODEBERG_TOKEN}" \
            "https://codeberg.org/api/v1/repos/unwanted9855/blended-strawberry/releases/tags/${{ env.tag_name }}")

          echo "Release check response: ${release_check}"

          release_id=""
          not_found=$(echo "${release_check}" | jq -r '.message // empty')

          if [ "${not_found}" = "The target couldn't be found." ] || [ "${not_found}" = "Not Found" ] || [ -z "${release_check}" ] || [ "${release_check}" = "null" ]; then
            echo "Creating new release for tag ${{ env.tag_name }}."
            release_data=$(jq -n --arg tag "${{ env.tag_name }}" \
              '{ tag_name: $tag, name: ("Release " + $tag), body: ("Release for tag " + $tag) }')

            release_response=$(curl -s -X POST \
              -H "Authorization: token ${CODEBERG_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "${release_data}" \
              "https://codeberg.org/api/v1/repos/unwanted9855/blended-strawberry/releases")

            echo "Release creation response: ${release_response}"
            release_id=$(echo "${release_response}" | jq -r '.id // empty')

            if [ -z "${release_id}" ] || [ "${release_id}" = "null" ]; then
              echo "Failed to create release. Response: ${release_response}"
              exit 1
            fi
          else
            # If the release exists, extract its ID.
            release_id=$(echo "${release_check}" | jq -r '.id // empty')
            if [ -z "${release_id}" ] || [ "${release_id}" = "null" ]; then
              echo "Error: Release ID is null. Response: ${release_check}"
              exit 1
            fi
            echo "Release for tag ${{ env.tag_name }} found."
          fi

          echo "Using release ID: ${release_id}"

          shopt -s nullglob
          for asset_name in *.dmg *.exe; do
            if [ -f "${asset_name}" ]; then
              upload_url="https://codeberg.org/api/v1/repos/unwanted9855/blended-strawberry/releases/${release_id}/assets?name=${asset_name}"
              echo "Uploading asset ${asset_name} to release for tag ${{ env.tag_name }}."

              response=$(curl -s -X POST \
                -H "Authorization: token ${CODEBERG_TOKEN}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"${asset_name}" \
                "${upload_url}" \
                -w "HTTPSTATUS:%{http_code}")

              http_code=$(echo "${response}" | sed -e 's/.*HTTPSTATUS://')
              response_body=$(echo "${response}" | sed -e 's/HTTPSTATUS.*//')

              echo "Upload response for ${asset_name}: ${response_body}"

              if [ "${http_code}" -ne 201 ]; then
                echo "Failed to upload ${asset_name}. HTTP Status: ${http_code}. Response: ${response_body}"
                if [ "${http_code}" -eq 404 ]; then
                  echo "Check if the target release ID ${release_id} is valid or if the asset name is correct."
                fi
                exit 1
              fi

              echo "Uploaded ${asset_name} successfully."
              sleep 2
            else
              echo "Asset ${asset_name} does not exist, skipping."
            fi
          done
