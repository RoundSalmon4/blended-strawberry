name: CI/CD Workflow

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: "Enable global test mode (intentionally fail at the very end)"
        type: boolean
        required: false
        default: false
      dry_run:
        description: "Global dry-run (skip side effects in composite actions)"
        type: boolean
        required: false
        default: true

permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: write
  deployments: write

# Global flags visible to every job
env:
  TEST_MODE: ${{ inputs.test_mode }}
  DRY_RUN: ${{ inputs.dry_run }}

jobs:
  update:
    name: Update from upstream
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Run Update Action
        uses: ./.github/actions/update
        with:
          dry_run: "${{ env.DRY_RUN }}"

  modify_git_revision:
    name: Modify Git Revision
    runs-on: ubuntu-latest
    needs: update
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Set INCLUDE_GIT_REVISION to OFF
        shell: bash
        run: |
          sed -i 's/set(INCLUDE_GIT_REVISION ON)/set(INCLUDE_GIT_REVISION OFF)/' cmake/Version.cmake

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: modify_git_revision
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Run Build Action
        uses: ./.github/actions/build
        with:
          build_type: "Release"
          dry_run: "${{ env.DRY_RUN }}"

  codeberg:
    name: Sync Codeberg Repo
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Run Codeberg Action
        uses: ./.github/actions/codeberg
        with:
          # codeberg_url: "https://codeberg.org/you/repo.git"  # set if needed
          dry_run: "${{ env.DRY_RUN }}"

  codeberg_release:
    name: Add Codeberg Release
    runs-on: ubuntu-latest
    needs: codeberg
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Run Codeberg Release Action
        uses: ./.github/actions/codeberg_release
        with:
          tag: "${{ github.ref_name }}"
          title: "Release ${{ github.ref_name }}"
          notes_path: "CHANGELOG.md"
          dry_run: "${{ env.DRY_RUN }}"

  codeberg_notes:
    name: Add Codeberg Notes
    runs-on: ubuntu-latest
    needs: codeberg_release
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Run Codeberg Notes Action
        uses: ./.github/actions/codeberg_notes
        with:
          release_tag: "${{ github.ref_name }}"
          notes_path: "CHANGELOG.md"
          dry_run: "${{ env.DRY_RUN }}"

  reset_git_revision:
    name: Reset Git Revision
    runs-on: ubuntu-latest
    needs: codeberg_notes
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Set INCLUDE_GIT_REVISION to ON
        shell: bash
        run: |
          sed -i 's/set(INCLUDE_GIT_REVISION OFF)/set(INCLUDE_GIT_REVISION ON)/' cmake/Version.cmake

  # Global test-mode gate â€” runs after all jobs and intentionally fails when enabled
  fail_if_test_mode:
    name: Fail run if global test mode is enabled
    runs-on: ubuntu-latest
    needs:
      - update
      - modify_git_revision
      - build
      - codeberg
      - codeberg_release
      - codeberg_notes
      - reset_git_revision
    if: always()   # evaluate regardless of earlier outcomes
    steps:
      - name: Check TEST_MODE and optionally fail
        shell: bash
        run: |
          echo "TEST_MODE=${{ env.TEST_MODE }}"
          if [ "${{ env.TEST_MODE }}" = "true" ]; then
            echo "Global test mode enabled: intentionally failing the workflow at the end."
            exit 1
          else
            echo "Global test mode disabled: completing workflow normally."
          fi
