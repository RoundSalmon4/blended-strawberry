name: All-in-One Orchestrator

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: "Intentionally fail after everything runs (prevents successful completion)."
        type: boolean
        required: false
        default: true
      dry_run:
        description: "Do not dispatch downstream workflows; only print what would happen."
        type: boolean
        required: false
        default: true

permissions:
  actions: write   # required to dispatch and read workflow runs
  contents: write  # your inline steps may modify files if you add commits later
  checks: read
  deployments: write

env:
  TEST_MODE: ${{ inputs.test_mode }}
  DRY_RUN: ${{ inputs.dry_run }}
  OWNER: RoundSalmon4
  REPO: blended-strawberry
  REF: master

jobs:
  # Utility job to show run flags
  echo_flags:
    name: Echo flags
    runs-on: ubuntu-latest
    steps:
      - name: Echo TEST_MODE and DRY_RUN
        run: |
          echo "TEST_MODE=${{ env.TEST_MODE }}"
          echo "DRY_RUN=${{ env.DRY_RUN }}"

  # 1) UPDATE
  dispatch_update:
    name: Dispatch update.yml and wait
    runs-on: ubuntu-latest
    needs: echo_flags
    steps:
      - name: Dry-run no-op
        if: ${{ env.DRY_RUN == 'true' }}
        run: echo "[DRY RUN] Would dispatch .github/workflows/update.yml on ref ${{ env.REF }}"

      - name: Dispatch and wait for update.yml
        if: ${{ env.DRY_RUN != 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = process.env.OWNER;
            const repo = process.env.REPO;
            const ref = process.env.REF;
            const workflowFile = '.github/workflows/update.yml';

            const wait = ms => new Promise(res => setTimeout(res, ms));
            const timeoutMs = 30 * 60 * 1000; // 30 minutes
            const pollEveryMs = 10 * 1000;    // 10 seconds
            const deadline = Date.now() + timeoutMs;

            // mark "now" so we can find the new run
            const startAt = new Date().toISOString();

            // Dispatch the workflow
            await github.rest.actions.createWorkflowDispatch({
              owner, repo,
              workflow_id: workflowFile,
              ref,
              inputs: {} // callee does not accept inputs; leave empty
            });

            // Find the new run
            let runId = null;
            while (Date.now() < deadline && !runId) {
              const { data } = await github.rest.actions.listWorkflowRuns({
                owner, repo,
                workflow_id: workflowFile,
