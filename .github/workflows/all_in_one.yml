name: CI/CD Workflow

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: "Enable global test mode (intentionally fail at the very end)"
        type: boolean
        required: false
        default: false
      dry_run:
        description: "Global dry-run (skip side effects in reusable workflows)"
        type: boolean
        required: false
        default: true

permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: write
  deployments: write

# Global flags visible to every job
env:
  TEST_MODE: ${{ inputs.test_mode }}
  DRY_RUN: ${{ inputs.dry_run }}

jobs:
  # 1) Update (reusable workflow)
  update:
    name: Update from upstream
    uses: RoundSalmon4/blended-strawberry/.github/workflows/update.yml@master
    with:
      dry_run: ${{ inputs.dry_run }}
    secrets: inherit

  # 2) Modify INCLUDE_GIT_REVISION (inline)
  modify_git_revision:
    name: Modify Git Revision
    runs-on: ubuntu-latest
    needs: update
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Set INCLUDE_GIT_REVISION to OFF
        shell: bash
        run: |
          sed -i 's/set(INCLUDE_GIT_REVISION ON)/set(INCLUDE_GIT_REVISION OFF)/' cmake/Version.cmake

  # 3) Build (reusable workflow)
  build:
    name: Build
    needs: modify_git_revision
    uses: RoundSalmon4/blended-strawberry/.github/workflows/build.yml@master
    with:
      dry_run: ${{ inputs.dry_run }}
      build_type: "Release"
    secrets: inherit

  # 4) Sync Codeberg (reusable workflow)
  codeberg:
    name: Sync Codeberg Repo
    needs: build
    uses: RoundSalmon4/blended-strawberry/.github/workflows/codeberg.yml@master
    with:
      dry_run: ${{ inputs.dry_run }}
      # codeberg_url: "https://codeberg.org/you/repo.git"  # <-- set if your workflow expects it
    secrets: inherit

  # 5) Codeberg Release (reusable workflow)
  codeberg_release:
    name: Add Codeberg Release
    needs: codeberg
    uses: RoundSalmon4/blended-strawberry/.github/workflows/codeberg_release.yml@master
    with:
      dry_run: ${{ inputs.dry_run }}
      tag: ${{ github.ref_name }}
      title: "Release ${{ github.ref_name }}"
      notes_path: "CHANGELOG.md"
    secrets: inherit

  # 6) Codeberg Notes (reusable workflow)
  codeberg_notes:
    name: Add Codeberg Notes
    needs: codeberg_release
    uses: RoundSalmon4/blended-strawberry/.github/workflows/codeberg_notes.yml@master
    with:
      dry_run: ${{ inputs.dry_run }}
      release_tag: ${{ github.ref_name }}
      notes_path: "CHANGELOG.md"
    secrets: inherit

  # 7) Reset INCLUDE_GIT_REVISION (inline)
  reset_git_revision:
    name: Reset Git Revision
    runs-on: ubuntu-latest
    needs: codeberg_notes
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Set INCLUDE_GIT_REVISION to ON
        shell: bash
        run: |
          sed -i 's/set(INCLUDE_GIT_REVISION OFF)/set(INCLUDE_GIT_REVISION ON)/' cmake/Version.cmake

  # Final: Global test-mode gate â€” intentionally fail at the very end if enabled
  fail_if_test_mode:
    name: Fail run if global test mode is enabled
    runs-on: ubuntu-latest
    needs:
      - update
      - modify_git_revision
      - build
      - codeberg
      - codeberg_release
      - codeberg_notes
      - reset_git_revision
    if: always()
    steps:
      - name: Check TEST_MODE and optionally fail
        shell: bash
        run: |
          echo "TEST_MODE=${{ env.TEST_MODE }}"
          if [ "${{ env.TEST_MODE }}" = "true" ]; then
            echo "Global test mode enabled: intentionally failing the workflow at the end."
            exit 1
          else
            echo "Global test mode disabled: completing workflow normally."
          fi
