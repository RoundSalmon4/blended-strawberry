name: CI/CD Workflow

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: "Enable global test mode (intentionally fail at the very end)"
        type: boolean
        required: false
        default: false
      dry_run:
        description: "Global dry-run (skip side effects in reusable workflows)"
        type: boolean
        required: false
        default: true

permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: write
  deployments: write

env:
  TEST_MODE: ${{ inputs.test_mode }}
  DRY_RUN: ${{ inputs.dry_run }}

jobs:
  update:
    name: Update from upstream
    uses: RoundSalmon4/blended-strawberry/.github/workflows/update.yml@master
    with:
      dry_run: ${{ inputs.dry_run }}
    secrets: inherit

  modify_git_revision:
    name: Modify Git Revision
    runs-on: ubuntu-latest
    needs: update
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master
      - name: Set INCLUDE_GIT_REVISION to OFF
        shell: bash
        run: |
          sed -i 's/set(INCLUDE_GIT_REVISION ON)/set(INCLUDE_GIT_REVISION OFF)/' cmake/Version.cmake

  build:
    name: Build
    needs: modify_git_revision
    uses: RoundSalmon4/blended-strawberry/.github/workflows/build.yml@master
    with:
      dry_run: ${{ inputs.dry_run }}
      build_type: "Release"
    secrets: inherit

  codeberg:
    name: Sync Codeberg Repo
    needs: build
    uses: RoundSalmon4/blended-strawberry/.github/workflows/codeberg.yml@master
    with:
      dry_run: ${{ inputs.dry_run }}
    secrets: inherit

  codeberg_release:
    name: Add Codeberg Release
    needs: codeberg
    uses: RoundSalmon4/blended-strawberry/.github/workflows/codeberg_release.yml@master
    with:
      dry_run: ${{ inputs.dry_run }}
      tag: ${{ github.ref_name }}
      title: "Release ${{ github.ref_name }}"
      notes_path: "CHANGELOG.md"
    secrets: inherit

  codeberg_notes:
    name: Add Codeberg Notes
    needs: codeberg_release
    uses: RoundSalmon4/blended-strawberry/.github/workflows/codeberg_notes.yml@master
    with:
      dry_run: ${{ inputs.dry_run }}
      release_tag: ${{ github.ref_name }}
      notes_path: "CHANGELOG.md"
    secrets: inherit

  reset_git_revision:
    name: Reset Git Revision
    runs-on: ubuntu-latest
    needs: codeberg_notes
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master
      - name: Set INCLUDE_GIT_REVISION to ON
        shell: bash
        run: |
          sed -i 's/set(INCLUDE_GIT_REVISION OFF)/set(INCLUDE_GIT_REVISION ON)/' cmake/Version.cmake

  fail_if_test_mode:
    name: Fail run if global test mode is enabled
    runs-on: ubuntu-latest
    needs:
      - update
      - modify_git_revision
      - build
      - codeberg
      - codeberg_release
      - codeberg_notes
      - reset_git_revision
    if: always()
    steps:
      - name: Check TEST_MODE and optionally fail
        shell: bash
        run: |
          echo "TEST_MODE=${{ env.TEST_MODE }}"
          if [ "${{ env.TEST_MODE }}" = "true" ]; then
            echo "Global test mode enabled: intentionally failing the workflow at the end."
            exit 1
          else
            echo "Global test mode disabled: completing workflow normally."
          fi
